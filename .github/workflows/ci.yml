name: CI

permissions:
  contents: read
  pages: write
  id-token: write

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  train-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Train baseline and calibrate
        run: |
          python -m scripts.train_baseline

      - name: Evaluate offline
        run: |
          python -m scripts.evaluate_offline

      - name: Streaming simulation (bounded)
        run: |
          python -m scripts.simulate_stream --alpha 0.05 --mode window --window 2000 --label_delay 200 --max_events 20000

      - name: Summarize offline metrics
        run: |
          python - <<'PY'
          import json, pathlib, os
          p = pathlib.Path('models/metrics_offline.json')
          d = json.loads(p.read_text())
          pre = d.get('metrics_pre', {})
          post = d.get('metrics_post', {})
          base = d.get('base_model', {})
          calib = d.get('calibration', {})
          lines = []
          lines.append(f"### StreamScore Offline Metrics\n")
          lines.append(f"- Base: {base.get('label','?')}  |  Valid AP: {base.get('valid_ap','?')}\n")
          lines.append(f"- Calibration: {calib.get('calibration_method','?')}\n")
          lines.append("")
          lines.append("| Metric | Pre | Post |")
          lines.append("|---|---:|---:|")
          for k in ("roc_auc","pr_auc","brier","nll"):
            lines.append(f"| {k} | {pre.get(k,'-')} | {post.get(k,'-')} |")
          summary = "\n".join(lines)
          with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
            f.write(summary + "\n")
          PY
      - name: Summarize streaming coverage
        run: |
          python - <<'PY'
          import json, os, pathlib
          p = pathlib.Path('artifacts/stream_summary.json')
          if p.exists():
            d = json.loads(p.read_text())
            lines = []
            lines.append('### Streaming Coverage')
            lines.append(f"- Mode: {d.get('mode')} | Alpha: {d.get('alpha')} | Label delay: {d.get('label_delay')}")
            lines.append(f"- Final coverage: {d.get('final_coverage')} | Final violation rate: {d.get('final_violation_rate')}")
            with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
              f.write('\n'.join(lines) + '\n')
          PY
      - name: Run tests
        run: |
          pytest -q

      - name: Upload model artifacts
        uses: actions/upload-artifact@v4
        with:
          name: models
          path: |
            models/**
          if-no-files-found: warn

      - name: Upload plots/artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts
          path: |
            artifacts/**
          if-no-files-found: warn

      - name: Build static site
        run: |
          python -m scripts.build_static_site

      - name: Upload Pages artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    runs-on: ubuntu-latest
    needs: train-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        continue-on-error: true


